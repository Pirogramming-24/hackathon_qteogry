{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q&A Service</title>
    
    <link rel="stylesheet" href="{% static 'questions/css/main_ny.css' %}">
    <link rel="stylesheet" href="{% static 'questions/understanding_check_upload.css' %}">
    <link rel="stylesheet" href="{% static 'questions/understanding_check.css' %}">
    <script src="{% static 'questions/understanding_check.js' %}" defer></script>
    <script src="{% static 'questions/comment_delete.js' %}" defer></script>
    
</head>
<body>

    {% comment %} understanding {% endcomment %}

    <!-- realtime.js ì •ë³´ ì „ë‹¬ìš© -->
    <div id="realtime-root"
        data-session-id="{{ session.id }}"
        data-question-id="{% if selected_question %}{{ selected_question.id }}{% endif %}">
    </div>

    <div class="header-container_ny">
        <div class="header-top_ny">
            
            <!-- â¬…ï¸ ì™¼ìª½: ì œëª© + íƒ­ -->
            <div class="header-left_ny">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 30px; padding: 0 20px;">
                    <a href="{% url 'live_sessions:session_list' %}" class="back-btn_ny" title="ì„¸ì…˜ ëª©ë¡ìœ¼ë¡œ">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </a>
                    
                    <h1 class="page-title_ny" style="margin: 0; padding: 0;">
                        {{ session.title }}
                    </h1>
                </div>

                <nav class="tab-menu_ny">
                    <a href="?sort=all" class="tab-item_ny {% if sort_mode == 'all' %}active_ny{% endif %}">ëª¨ë“  ì§ˆë¬¸</a>
                    <a href="?sort=pending" class="tab-item_ny {% if sort_mode == 'pending' %}active_ny{% endif %}">ëŒ€ê¸°ì¤‘ì¸ ì§ˆë¬¸ë§Œ</a>
                    <a href="?sort=concept" class="tab-item_ny {% if sort_mode == 'concept' %}active_ny{% endif %}">ê°œë… ì§ˆë¬¸ë§Œ</a>
                    <a href="?sort=likes" class="tab-item_ny {% if sort_mode == 'likes' %}active_ny{% endif %}">ê³µê° ìˆœìœ¼ë¡œ</a>
                    <a href="?sort=my" class="tab-item_ny {% if sort_mode == 'my' %}active_ny{% endif %}">ë‚´ ì§ˆë¬¸</a>
                </nav>
            </div>

            <div class="header-right_ny">
                
                {% if understanding_check %}
                    <div class="understanding-check-bar-hs">
                        
                        <div class="check-header-hs" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div class="timer-area" style="font-weight: bold; color: #7FD957; font-size: 1.1em;">
                                â±ï¸ <span id="realtime-timer">00:00</span>
                            </div>
                            
                            {% if understanding_check.ended_at %}
                                <span style="color: #FF6B6B; font-weight: bold; font-size: 0.9em;">
                                    ì¢…ë£Œë¨ (ë‚œì´ë„: {{ understanding_check.difficulty_level }})
                                </span>
                            {% else %}
                                <span style="color: #888; font-size: 0.9em;">ì§„í–‰ ì¤‘...</span>
                            {% endif %}
                        </div>

                     <div class="check-content-hs" style="margin-bottom: 10px;">
                         ğŸ§  {{ understanding_check.content }}
                     </div>

                        <div class="check-progress-hs">
                            <span id="count-text" style="font-size: 0.9em; color: #ccc;">
                                {{ response_count }} / {{ understanding_check.target_response_count }}
                            </span>
                            <div class="progress-bar-bg">
                                <div id="progress-bar" class="progress-bar-fill" style="width: {{ progress }}%;"></div>
                            </div>
                        </div>

                        <div class="check-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                            
                            {% if not understanding_check.ended_at %}
                                <button type="button" id="yes-btn" class="check-btn-yes"
                                    data-id="{{ understanding_check.id }}"
                                    data-url="{% url 'questions:understanding_check_respond' %}"
                                    data-csrf="{{ csrf_token }}"
                                    style="flex: 2; background-color: #7FD957; color: black; border: none; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                    ë„¤!
                                </button>

                                <a href="{% url 'questions:understanding_check_finish' understanding_check.id %}" 
                                onclick="return confirm('íˆ¬í‘œë¥¼ ê°•ì œë¡œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');"
                                style="flex: 1; background-color: #333; color: #ccc; text-align: center; padding: 8px; border-radius: 8px; text-decoration: none; font-size: 0.9em; display: flex; align-items: center; justify-content: center;">
                                â›” ì¢…ë£Œ
                                </a>

                            {% else %}
                                <a href="{% url 'questions:understanding_check_upload' %}" 
                                style="width: 100%; background-color: #7FD957; color: black; text-align: center; padding: 10px; border-radius: 8px; text-decoration: none; font-weight: bold;">
                                ğŸ”„ ìƒˆë¡œìš´ ì´í•´ë„ Check ìƒì„±í•˜ê¸°
                                </a>
                            {% endif %}
                        </div>

                        <input type="hidden" id="uc-start-time" value="{{ understanding_check.created_at|date:'c' }}">
                        <input type="hidden" id="uc-end-time" value="{{ understanding_check.ended_at|date:'c'|default:'' }}">
                    </div>

                {% else %}
                    <div class="understanding-check-bar-hs" style="justify-content: center; padding: 20px;">
                        <a href="{% url 'questions:understanding_check_upload' %}" class="check-upload-btn-hs">
                            ìƒˆë¡œìš´ ì´í•´ë„ Check ì˜¬ë¦¬ê¸°
                        </a>
                    </div>
                {% endif %}

            </div>
        </div>
    </div>


    <main class="main-container_ny">
        
        <section class="question-list_ny" id="question-list">
            {% for question in questions %}
            <a href="{% url 'questions:question_detail' session.id question.id %}?sort={{ sort_mode }}" style="text-decoration: none; color: inherit;">
                <div id="card-{{ question.id }}" class="question-card_ny status-{{ question.status }}">
                    <div class="card-header_ny">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="width: 30px; height: 30px; background: #ddd; border-radius: 50%;"></div>
                            <span style="font-weight: bold;">{{ question.user.username }}</span>
                        </div>
                        <span class="badge_ny 
                            {% if question.category == 'CONCEPT' %}badge-concept_ny
                            {% elif question.category == 'ERROR' %}badge-error_ny
                            {% else %}badge-etc_ny{% endif %}">
                            {{ question.get_category_display }}
                        </span>
                    </div>

                    <a href="{% url 'questions:question_detail' session.id question.id %}" style="text-decoration: none; color: inherit;">
                        <div class="card-content_ny">
                            {{ question.title }}
                        </div>
                    </a>

                    <div class="card-footer_ny">
                        <span>{{ question.created_at|date:"Y.m.d H:i" }}</span>
                        <span class="like-btn_ny" data-question-id="{{ question.id }}" style="cursor: pointer; z-index: 10;">
                            ì €ë„ ê¶ê¸ˆí•´ìš” ğŸ˜¢ 
                            <span id="like-count-list-{{ question.id }}">{{ question.likes.count }}</span>
                        </span>
                    </div>
                </div>
            </a>

            {% empty %}
                <p id="empty-questions" style="text-align: center; color: #888; margin-top: 50px;">
                    ì•„ì§ ë“±ë¡ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.
                </p>
            {% endfor %}

            <a href="{% url 'questions:question_main' session.id %}" class="floating-btn_ny" title="ì§ˆë¬¸ ì‘ì„±í•˜ê¸°">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="black"/>
                </svg>
            </a>
            
        </section>

        <section class="write-section_ny">

            {% if selected_question %}
            
                <div class="question-detail-container-hs">
                    <div class="question-meta-hs">
                        <span class="question-user-hs">ğŸ‘¤ {{ selected_question.user }}</span>
                        <span class="badge_ny" style="margin-left: 10px;">{{ selected_question.get_category_display }}</span>
                    </div>

                    <h2 class="question-title-hs" style="color: #65E01D; margin-top: 10px;">
                        {{ selected_question.title }}
                    </h2>

                    <div class="question-info-hs" style="color: #888; font-size: 14px; margin-bottom: 20px;">
                        <span>{{ selected_question.created_at|date:"Y.m.d H:i" }}</span>
                        <span style="float: right;">
                            <div class="question-status-wrapper">
                                <select class="status-select_ny" data-question-id="{{ selected_question.id }}">
                                    <option value="OPEN" {% if selected_question.status == 'OPEN' %}selected{% endif %}>
                                        ğŸŸ¡ ëŒ€ê¸°
                                    </option>
                                    <option value="ANSWERED" {% if selected_question.status == 'ANSWERED' %}selected{% endif %}>
                                        âœ… ë‹µë³€ì™„ë£Œ
                                    </option>
                                </select>
                            </div>
                        </span>
                    </div>

                    <hr style="border: 0.5px solid #333; margin-bottom: 20px;">

                    {% if selected_question.image %}
                        <div class="question-image-hs" style="margin-bottom: 20px;">
                            <img src="{{ selected_question.image.url }}" alt="ì§ˆë¬¸ ì´ë¯¸ì§€" style="max-width: 100%; border-radius: 8px;">
                        </div>
                    {% endif %}

                    <div class="question-content-hs" style="font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
                        {{ selected_question.content|linebreaks }}
                    </div>

                    <div class="question-like-hs" style="text-align: center; margin-bottom: 30px;">
                        <button class="like-btn_ny" data-question-id="{{ selected_question.id }}" 
                                style="background: #333; color: white; border: 1px solid transparent; padding: 10px 20px; border-radius: 20px; cursor: pointer; transition: 0.3s;">
                            ğŸ˜¢ ì €ë„ ê¶ê¸ˆí•´ìš” 
                            <span id="like-count-detail-{{ selected_question.id }}">{{ like_count }}</span>ê°œ
                        </button>
                    </div>

                    <hr style="border: 0.5px solid #333;">

                    <div class="comment-section-hs">
                        <h4 style="color: #65E01D;">ğŸ’¬ ëŒ“ê¸€</h4>

                        <style>
                            /* ì´ í˜ì´ì§€ ì•ˆì—ì„œë§Œ ë™ì‘: ëŒ“ê¸€ ì„¹ì…˜ ì•ˆì˜ ì…ë ¥ì°½ ë†’ì´ ì¤„ì´ê¸° */
                            .comment-section-hs .input-content_ny {
                                min-height: 50px !important; /* ê¸°ì¡´ 200px ë¬´ì‹œ */
                                height: 50px !important;     /* ë†’ì´ 50pxë¡œ ê³ ì • */
                                padding: 10px 12px !important;
                                line-height: 1.4;
                            }
                        </style>

                        {% if comments %}
                        <ul class="comment-list-hs" style="list-style: none; padding-left: 0;">
                        {% for comment in comments %}
                        <li class="comment-item-hs"
                            data-id="{{ comment.id }}"
                            style="background:#2C2C2C; padding:15px; border-radius:8px; margin-bottom:10px;">

                            <div class="comment-meta-hs">
                                <span class="comment-user-hs">{{ comment.user }}</span>

                                <div class="comment-right-hs">
                                    <span class="comment-created-at-hs">
                                    {{ comment.created_at|date:"Y.m.d H:i" }}
                                    </span>

                                    {% if comment.user == request.user %}
                                    <button
                                    class="comment-delete-btn"
                                    data-id="{{ comment.id }}"
                                    data-url="{% url 'questions:comment_delete' %}"
                                    data-csrf="{{ csrf_token }}"
                                    >
                                    ì‚­ì œ
                                    </button>
                                    {% endif %}
                                </div>
                            </div>


                            <div class="comment-content-hs">
                            {{ comment.content|linebreaks }}
                            </div>
                        </li>
                        {% endfor %}
                        </ul>
                        {% else %}
                        <p class="no-comment-hs">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}


                        {% if user.is_authenticated %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="question_id" value="{{ selected_question.id }}">
                            {{ cform.content }}
                            <button type="submit" name="submit_comment" 
                                style="width: 100%; 
                                       margin-top: 10px; 
                                       padding: 12px; 
                                       background-color: #65E01D; 
                                       color: #111; 
                                       border: none; 
                                       border-radius: 6px; 
                                       font-weight: 800; 
                                       cursor: pointer; 
                                       font-size: 14px;
                                       transition: background-color 0.2s;">
                                ëŒ“ê¸€ ë“±ë¡
                            </button>
                        </form>
                        {% else %}
                        <p style="color:#888; text-align:center; margin-top:20px;">
                            ë¡œê·¸ì¸ í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                        {% endif %}
                    </div>
                </div>

                {% else %}
            
                <div class="form-title_ny">ì§ˆë¬¸ ì‘ì„±í•˜ê¸°</div>
                
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if qform.errors %}
                        <div style="background: #FF6B6B; color: white; padding: 10px; margin-bottom: 20px; border-radius: 8px;">
                            <p style="margin: 0; font-weight: bold;">âš ï¸ ë‹¤ìŒ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”:</p>
                            {% for field in qform %}
                                {% for error in field.errors %}
                                    <p style="margin: 5px 0 0 0; font-size: 0.9em;">
                                        â€¢ {{ field.label }}: {{ error }}
                                    </p>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="form-group_ny">
                        <label>ì§ˆë¬¸ ì¢…ë¥˜</label>
                        {{ qform.category }}
                    </div>
                    <div class="form-group_ny">
                        <label>ì œëª©</label>
                        {{ qform.title }}
                    </div>
                    <div class="form-group_ny">
                        <label>ë‚´ìš©</label>
                        {{ qform.content }}
                    </div>
                    <div class="form-group_ny">
                        <label>ì´ë¯¸ì§€ ì²¨ë¶€</label>
                        {{ qform.image }}
                    </div>
                    
                    <button type="submit" class="submit-btn_ny" name="submit_question">ì§ˆë¬¸ ë“±ë¡í•˜ê¸°</button>
                </form>

            {% endif %}
        </section>
    </main>
   

    <script src="{% static 'questions/js/realtime.js' %}"></script>
    <script src="{% static 'questions/js/main_ny.js' %}"></script>
</body>
</html>